# Shrouded API

## Configuration

See .example.env for configurable parameters.

```sh
npm run dev
```

## Understanding the program

An E2E test has been created at `test/e2e.ts` to facilitate the understanding of how this backend should be used. The scenario is explained in the file comment.

```txt
[Setup] Generating circuit +0ms
[Admin] Creating new identity group +2s
{
  identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
  name: 'TESTING-GROUP-5b731cef-644f-4459-990a-3e2da8d6fc04'
} +0ms
[Admin] Identity group created: 3cf52405-fb16-49b8-b527-0bdfb4c1eff6 +267ms
[Beneficiary 1] Generating identity +0ms
{
  keypair: {
    pubKey: [
      350740956551250705214987504665266975801031435200532522672855063012732874353n,
      5269281482163661041517939318996085075131524331642910892609592578530910250309n
    ],
    privKey: <Buffer ed dc 8b 61 24 5d b5 af 21 0c 22 54 bf a6 93 6d 72 e8 fd 6d 81 c8 f3 a6 d9 3d ec 4c 74 41 e4 fa>
  },
  identityNullifier: 202347954406892800823928141326719998596564709375450462659611594189994687713n,
  identityTrapdoor: 424486514784792947204882796652646236828875758921402080636399431563042088049n
} +114ms
[Beneficiary 1] Generating identity commitment +111ms
[Beneficiary 1] Identity commitment: 5670441046312515395089567490843220533481600897314437395572831854447937261945 +671ms
[Beneficiary 2] Generating identity +0ms
{
  keypair: {
    pubKey: [
      16294649383507685716231213588054890377608487763962122930733987663372615587625n,
      1316903913154966532104427018627509755912821745438879593434946629090568502048n
    ],
    privKey: <Buffer c9 12 43 bf 70 c9 7f 40 38 76 16 64 0b 3f e7 b1 55 ee da 0b 2c f6 56 41 24 32 a9 c2 9b a3 87 03>
  },
  identityNullifier: 287635148435222581931159341869104073538528497534701690600888149033348288979n,
  identityTrapdoor: 428633634755015402543220609018967836030194341805052840127100006547540107825n
} +750ms
[Beneficiary 2] Generating identity commitment +79ms
[Beneficiary 2] Identity commitment: 14203514989670951254926267063248638126316664879862808861407710434551369067567 +313ms
[Admin] Registering beneficiary 1 identity commitment +0ms
{
  identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
  identityCommitment: '5670441046312515395089567490843220533481600897314437395572831854447937261945'
} +440ms
[Admin] Registering beneficiary 2 identity commitment +129ms
{
  identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
  identityCommitment: '14203514989670951254926267063248638126316664879862808861407710434551369067567'
} +203ms
[Program Owner] Using external nullifier: FOOD_COLLECTION-20210115 +204ms
BigNumber {
  _hex: '0x464f4f445f434f4c4c454354494f4e2d3230323130313135',
  _isBigNumber: true
} +5ms
[Beneficiary 1] Generating claim for given program +2ms
[Beneficiary 1] Fetching identity commitment list +0ms
[
  {
    identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
    identityCommitment: '14203514989670951254926267063248638126316664879862808861407710434551369067567'
  },
  {
    identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
    identityCommitment: '5670441046312515395089567490843220533481600897314437395572831854447937261945'
  }
] +257ms
[Beneficiary 1] Building local identity commitment tree +256ms
[
  BigNumber {
    _hex: '0x1f66e7939c55d699cf3568c13ddcfc72897e3fcfeae93a957874a9add6a06c2f',
    _isBigNumber: true
  },
  BigNumber {
    _hex: '0x0c895b1c0f98fa1c3b73494e25c3dba65489312a9d403e9ab5509411b3711179',
    _isBigNumber: true
  }
] +1ms
[Beneficiary 1] Generating witness +2ms
[Beneficiary 1] Generating proof +5s
{
  pi_a: [
    13152916898568626751663943846277646276824524603942724617251125951667211927946n,
    6570569318010475923154154209295447380732919360670136774501846382031156338331n,
    1n
  ],
  pi_b: [
    [
      2777756540867876850976645364464945326307712448829676586936299520098960144695n,
      9023639278554049203002162399222277434126076947661873704508689589664253234764n
    ],
    [
      10179778203658333176605659052662193027885441197119593791683423175048910824018n,
      10663779759812064083913541516140756236466083003947972047589957818912292511619n
    ],
    [ 1n, 0n ]
  ],
  pi_c: [
    14625987718161697816488080099259175606915306523091408807315141760321903094289n,
    311702119016542090874682127707961115459344731107448386653943312098241520018n,
    1n
  ]
} +20s
[Beneficiary 1] Generating public signal +15s
[
  15456193694570897017486779502376898279412523586670086337677971557885341901516n,
  719739271802115620109154458457783647900532048870971696533125059658944714450n,
  324435173924234642046472247965735262526828400981893803033103980410751275176n,
  1723991359837900747271504961393156169423940698095754490165n
] +1ms
[Beneficiary 1] Constructing claim payload +0ms
{
  proof: {
    snarkProof: { pi_a: [Array], pi_b: [Array], pi_c: [Array] },
    merkleRoot: '15456193694570897017486779502376898279412523586670086337677971557885341901516'
  },
  nullifier: '719739271802115620109154458457783647900532048870971696533125059658944714450',
  identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
  externalNullifier: 'FOOD_COLLECTION-20210115',
  message: 'ABC PTE LTD'
} +0ms
[Beneficiary 1] Submitting Claim +1ms
{ success: true } +3s
[Program Owner] Checking Claims +1ms
[
  {
    identityGroup: '3cf52405-fb16-49b8-b527-0bdfb4c1eff6',
    externalNullifier: 'FOOD_COLLECTION-20210115',
    nullifier: '719739271802115620109154458457783647900532048870971696533125059658944714450',
    message: 'ABC PTE LTD',
    proof: {
      merkleRoot: '15456193694570897017486779502376898279412523586670086337677971557885341901516',
      snarkProof: [Object]
    }
  }
] +3s
[Public Info] +51ms
Identity Group: 3cf52405-fb16-49b8-b527-0bdfb4c1eff6 +0ms
Identity Group Merkle Root: 15456193694570897017486779502376898279412523586670086337677971557885341901516 +0ms
External Nullifier: FOOD_COLLECTION-20210115 +0ms
Nullifier: 719739271802115620109154458457783647900532048870971696533125059658944714450 +0ms
Message: ABC PTE LTD +0ms
[Private Info] +1ms
Beneficiary 1 Private Key: eddc8b61245db5af210c2254bfa6936d72e8fd6d81c8f3a6d93dec4c7441e4fa +0ms
Beneficiary 1 Public Key: 3507409565512507052149875046652669758010314352005325226728550630127328743535269281482163661041517939318996085075131524331642910892609592578530910250309 +0ms
Beneficiary 1 Identity Nullifier: 202347954406892800823928141326719998596564709375450462659611594189994687713 +0ms
Beneficiary 1 Identity Trapdoor: 424486514784792947204882796652646236828875758921402080636399431563042088049 +0ms

Done in 32.72s.
```

## Notes

### Application usage pattern

1. Identity group admin creates a new identity group
1. (Offline) Beneficiary communicate identity commitment to identity group admin
1. Identity group admin insert identity commitment(s) into group
1. Beneficiary (whose identity commitment is inserted) fetch entire identity commitment list (mvp, use merkle path to save space)
1. (Offline) Beneficiary generates claim proof
1. Beneficiary submits claim proof
1. Anyone to read the claim ledger

### TODO

- Filter claim endpoint

### Gotchas

- Retrieval of identity commitments is ordered by sort key instead of time added
